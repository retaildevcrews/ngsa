# TODO: title

Rough notes

## Prerequisites

- follow aks-secure-baseline walkthrough

## Infrastructure notes

- Hub network from walkthrough is in eastus2
- First spoke network from walkthrough is in eastus2
- First AKS cluster from walkthrough is in the eastus2 spoke
- `rg-bu0001a0008` resource group is for the application team
  - bu0001 is for Business Unit 0001
  - 0008 is the application ID
- flux is installed in the cluster as part of the walkthrough
  - it is in the `cluster-baseline-settings` namespace
- the aks cluster names are generated by
  - `"subRgUniqueString": "[uniqueString('aks', subscription().subscriptionId, resourceGroup().id)]",`

## Decisions & Questions

### resource groups

Using the existing resource groups for this spike.

```txt

For NGSA, we'll use `ngsa-pre-shared-rg`, and `ngsa-pre-app-rg`.

```

### cosmos

Create cosmos in rg-bu0001a0008. Using the first spoke network for simplicity because it is already there. This will be in `eastus2` for the spike.

```txt

For NGSA, cosmos is in centralus.

Investigate network configurations for cosmos? Using the default "All networks" option for this spike.

```

### flux

The `cluster-manifests` directory was copied as-is from aks-secure-baseline.

```txt

cluster-manifests/cluster-baseline-settings/flux.yaml was edited to point this spike.

NGSA is using helm to deploy flux. Check that settings in aks-secure-baseline are in sync with helm settings during install.

How to integrate aks-secure-baseline cluster workloads into NGSA?

NGSA uses helm operator because of helm charts. Add that to NGSA aks-secure-baseline setup.

```

### NGSA

Copied chart from gitops so it could be easily modified for the spike.

```txt

Removed templates from the chart that are not needed.

Creating NGSA namespace and secrets like normal for this spike.

How to integrate the ngsa secrets with the key vault?

Imported images from GitHub container registry into private ACR.

How to handle NGSA docker images? Keep in sync with private registry? Update policies to allow the images? Or something else?

Did not install keda. Should it be installed?

Reduced resource limits for deployments.

Update policy to match NGSA defaults, or update NGSA default to match policy.

Using https hit URL for the helm release. This was to get around the need to add an SSH key to the repo for this spike.

```

## Commands

Create cosmos

```bash

export Imdb_Name="ngsa-pnp-spike-cosmos"
export Imdb_RG="rg-bu0001a0008"
export Imdb_DB=imdb
export Imdb_Col=movies
export Imdb_RW_Key='az cosmosdb keys list -n $Imdb_Name -g $Imdb_RG --query primaryMasterKey -o tsv'

az cosmosdb create -g $Imdb_RG -n $Imdb_Name
az cosmosdb sql database create -a $Imdb_Name -n $Imdb_DB -g $Imdb_RG --throughput 1000
az cosmosdb sql container create -p /partitionKey -g $Imdb_RG -a $Imdb_Name -d $Imdb_DB -n $Imdb_Col

docker run -it --rm retaildevcrew/imdb-import $Imdb_Name $(eval $Imdb_RW_Key) $Imdb_DB $Imdb_Col

```

Flux setup

```bash

# get access to a cluster
az aks get-credentials --resource-group rg-bu0001a0008 --name aks-ioxqpbmcqokqq

# install flux
kubectl apply -f cluster-manifests/cluster-baseline-settings/flux.yaml

# wait for deployment to be ready
kubectl wait -n cluster-baseline-settings --for=condition=ready pod --selector=app.kubernetes.io/name=flux --timeout=90s

# import helm operator to private ACR
ACR_NAME=$(az deployment group show -g rg-bu0001a0008 -n cluster-stamp --query properties.outputs.containerRegistryName.value -o tsv)
az acr import --source docker.io/fluxcd/helm-operator:1.2.0 -n $ACR_NAME

# add flux repo
helm repo add fluxcd https://charts.fluxcd.io

# deploy flux CRDs for helm operator
kubectl apply -f https://raw.githubusercontent.com/fluxcd/helm-operator/master/deploy/crds.yaml

# install helm operator
helm upgrade -i helm-operator fluxcd/helm-operator --wait \
--namespace cluster-baseline-settings \
--set git.ssh.secretName=flux-git-deploy \
--set helm.versions=v3 \
--set image.repository="${ACR_NAME}.azurecr.io/fluxcd/helm-operator" \
--set image.tag=1.2.0

```

NGSA setup

```bash

# create ngsa namespace
kubectl create namespace ngsa

# create ngsa secrets
kubectl create secret generic ngsa-secrets \
  --namespace ngsa \
  --from-literal=CosmosDatabase=$Imdb_DB \
  --from-literal=CosmosCollection=$Imdb_Col \
  --from-literal=CosmosKey=$(az cosmosdb keys list -n $Imdb_Name -g $Imdb_RG --query primaryReadonlyMasterKey -o tsv) \
  --from-literal=CosmosUrl=https://${Imdb_Name}.documents.azure.com:443/

az acr import --source ghcr.io/retaildevcrews/ngsa-app:beta -n $ACR_NAME
az acr import --source ghcr.io/retaildevcrews/ngsa-lr:beta -n $ACR_NAME

```
